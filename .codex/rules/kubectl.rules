# nix develop wrapper - deny secret content access (output flags)
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "secret", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "secret", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "secrets", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "secrets", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "externalsecret", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "externalsecret", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "externalsecrets", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "externalsecrets", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "secretstore", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "secretstore", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "secretstores", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "secretstores", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "clustersecretstore", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "clustersecretstore", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "clustersecretstores", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get", "clustersecretstores", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")

# nix develop wrapper - allow information seeking
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "get"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "describe"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "logs"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "top"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "events"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "api-resources"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "api-versions"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "cluster-info"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "version"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "kubectl", "explain"], decision = "allow")

prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "flux", "get"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "flux", "logs"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "flux", "check"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "flux", "tree"], decision = "allow")
prefix_rule(pattern = ["nix", "develop", "-c", "env", "KUBECONFIG=./kubeconfig", "flux", "trace"], decision = "allow")

# deny secret content access (output flags)
prefix_rule(pattern = ["kubectl", "get", "secret", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "secret", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "secrets", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "secrets", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "externalsecret", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "externalsecret", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "externalsecrets", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "externalsecrets", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "secretstore", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "secretstore", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "secretstores", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "secretstores", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "clustersecretstore", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "clustersecretstore", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "clustersecretstores", "-o"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")
prefix_rule(pattern = ["kubectl", "get", "clustersecretstores", "--output"], decision = "forbidden", justification = "Agents should not access secrets content. Listing secrets without output flags is permitted.")

# allow other information seeking
prefix_rule(pattern = ["kubectl", "get"], decision = "allow")
prefix_rule(pattern = ["kubectl", "describe"], decision = "allow")
prefix_rule(pattern = ["kubectl", "logs"], decision = "allow")
prefix_rule(pattern = ["kubectl", "top"], decision = "allow")
prefix_rule(pattern = ["kubectl", "events"], decision = "allow")
prefix_rule(pattern = ["kubectl", "api-resources"], decision = "allow")
prefix_rule(pattern = ["kubectl", "api-versions"], decision = "allow")
prefix_rule(pattern = ["kubectl", "cluster-info"], decision = "allow")
prefix_rule(pattern = ["kubectl", "version"], decision = "allow")
prefix_rule(pattern = ["kubectl", "explain"], decision = "allow")

prefix_rule(pattern = ["flux", "get"], decision = "allow")
prefix_rule(pattern = ["flux", "logs"], decision = "allow")
prefix_rule(pattern = ["flux", "check"], decision = "allow")
prefix_rule(pattern = ["flux", "tree"], decision = "allow")
prefix_rule(pattern = ["flux", "trace"], decision = "allow")
