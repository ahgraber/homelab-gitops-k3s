# Bootstrap

## Structure

- `helmfile.d/00-crds.yaml`: Extracts CRDs from charts before app install.
- `helmfile.d/01-apps.yaml`: Installs core cluster apps via Helmfile.
- `helmfile.d/templates/values.yaml.gotmpl`: Reads HelmRelease values to
  keep bootstrap Helmfile in sync with Flux-managed HelmReleases and expands
  `${SECRET}` placeholders using cluster secrets.
- `resources.yaml.j2`: Optional bootstrap-only resources (applied if present).

## Prerequisites

- `kubectl`, `helmfile`, `kustomize`, `yq`, `sops`
- A working k3s cluster with kubeconfig at `./kubeconfig` (generated by Ansible).
  (_Note: `kube-vip` and initial `cilium` are default-installed by `k3s-install` playbook_)

## Usage

1. Wait for nodes to become ready.

2. Apply namespace manifests:

   ```sh
   bash ./scripts/bootstrap/apply_namespaces.sh
   ```

3. Apply bootstrap-only secrets/resources.

   ```sh
   # old
   bash ./scripts/bootstrap/apply_apply_sops_secrets.sh

   # new
   minijinja-cli "bootstrap/resources.yaml.j2" | op inject
   ```

4. Install CRDs via Helmfile.

   ```sh
   bash ./scripts/bootstrap/apply_crds.sh
   ```

5. Install core apps via Helmfile.

   ```sh
   bash ./scripts/bootstrap/sync_hrs.sh
   ```

6. Confirm initial deployment and cluster rollout
