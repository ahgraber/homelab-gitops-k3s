# Bootstrap (Task + Helmfile)

This directory mirrors the bootstrap layout from
[onedr0p/home-ops](https://github.com/onedr0p/home-ops/tree/main/bootstrap)
while adapting it for Debian-based k3s nodes and Task-based automation.

## Structure

- `helmfile.d/00-crds.yaml`: Extracts CRDs from charts before app install.
- `helmfile.d/01-apps.yaml`: Installs core cluster apps via Helmfile.
- `helmfile.d/templates/values.yaml.gotmpl`: Reads HelmRelease values to
  keep bootstrap Helmfile in sync with Flux-managed HelmReleases.
- `resources.yaml.j2`: Optional bootstrap-only resources (applied if present).

## Prerequisites

- `kubectl`, `helmfile`, `kustomize`, `yq`, `sops`
- A working kubeconfig at `./kubeconfig` (generated by Ansible).

## Usage

Set the Bitwarden Secrets Manager access token and run the bootstrap task from the repository root:

```bash
export BWS_ACCESS_TOKEN="your-bitwarden-token"
task bootstrap:all
```

This performs the same stages as onedr0p's bootstrap process (minus Talos):

1. Wait for nodes to become ready.
2. Apply namespace manifests.
3. Apply bootstrap-only resources.
4. Install CRDs via Helmfile.
5. Install core apps via Helmfile.
6. Install Flux and its configuration.

You can run individual stages as needed:

```bash
task bootstrap:crds
task bootstrap:apps
task bootstrap:flux
```

## Notes

- This flow does **not** modify any `*.sops.yaml` files.
- Helmfile values are sourced from the existing Flux HelmRelease manifests.
