---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/clusterexternalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
# The ClusterExternalSecret creates an ExternalSecret in each namespace
# that does not have the label "clustersecret.external-secrets.io/disable" set to "true".
# The ExternalSecret will sync the secret data from the external secret store
# into an actual Kubernetes Secret in the namespace.
metadata:
  name: &secretname "cluster-secrets"
spec:
  externalSecretName: *secretname
  namespaceSelectors:
    - matchExpressions:
        # Exclude namespaces with this label set to "true"
        - key: clustersecret.external-secrets.io/disable
          operator: NotIn
          values:
            - "true"

  externalSecretSpec:
    refreshInterval: 1h
    secretStoreRef:
      kind: ClusterSecretStore
      name: "onepassword"
    target:
      creationPolicy: Owner
      deletionPolicy: Retain
      name: *secretname
      template:
        data:
          SECRET_DOMAIN: "{{ .SECRET_DOMAIN }}"
          SECRET_INT_DOMAIN: "{{ .SECRET_INT_DOMAIN }}"
          SECRET_RESTIC_PWD: "{{ .SECRET_RESTIC_PWD }}"
          SECRET_S3_ENDPOINT: "{{ .SECRET_S3_ENDPOINT }}"
    dataFrom:
      - extract:
          # all available properties from the key will be synced
          key: "shared.cluster-secrets"
