# 🌐 Networking

```txt
           "appname.domain.com"

       internal:             external:

                         ┌───────────────┐
      *dns lookup*       │ external-dns  │
           │             │   creates     │
           ▼             │  dns record   │
       split-dns:        └──────┬────────┘
     if domain.com:             │
    use k8s_gateway             ▼
      as resolver          *dns lookup*
           │                    │
           │                    │
   ┌───────▼───────┐            ▼
   │  k8s_gateway  │          public
   │  10.2.118.2   │       cloudflare IP
   └───────┬─┬─────┘            │
           │ │                  │
           │ │                ┌─▼─────────────┐
           │ │                │               │
┌──────────┼─┼────────────────┤  cloudflared  │
│          │ │                │               │
│          │ └────────┐       └──┬──────────┬─┘
│          │          │          │          │
│  ┌───────▼───────┐  │  ┌───────▼───────┐  │
│  │   Cilium GW   │  │  │   Cilium GW   │  │
│  │   internal    │  └──►   external   │  │
│  │   10.2.118.3  │     │   10.2.118.4 │  │
│  └───────┬───────┘     └───────┬───────┘  │
│          │                     │          │
│          │                     │          │
│  ┌───────▼───────┐     ┌───────▼───────┐  │
│  │   internal    │     │   external    │  │
│  │  application  │     │  application  │  │
│  └───────────────┘     └───────────────┘  │
│                                           │
└───────────────────────────────────────────┘
 k8s cluster
 https://asciiflow.com/
```

## 🌎 Public Applications

The `external-dns` application will create public DNS records.
External-facing application access relies on a `cloudflared` tunnel to access the external Cilium Gateway,
which terminates TLS for HTTPRoutes attached to it before proxying traffic to the application.

By default, `echo-server` and the `flux-webhook` are the only subdomains reachable from the public internet.
In order to make additional applications public you must configure HTTPRoute parent references and annotations (see the `echo-server` HelmRelease).

## ⚠️ Cilium Gateway migration notes

Replacing ingress-nginx with the Cilium Gateway is not a drop-in swap. Expect to review each workload and Helm chart for the following edge cases:

* **Ingress resources still generated by charts must stay disabled.** Many charts enable an Ingress by default; ensure those values remain `false` and rely on explicit Gateway API objects instead. The Prefect and Goldilocks releases in this repository illustrate the pattern of disabling chart-managed ingresses and defining HTTPRoutes alongside the HelmRelease.
* **Every application needs an HTTPRoute that targets the appropriate listener.** Routes must point at the `internal` or `external` gateway with the correct `sectionName` (`https` for cross-namespace routes in this cluster). Without that object, the gateway will never forward traffic to the Service.
* **Legacy nginx annotations do not exist.** Features such as request/response rewriting, custom auth, or rate limits must be translated into Gateway API filters or implemented with dedicated middleware components. Some nginx-specific behaviors (e.g. regex rewrite annotations) currently have no equivalent and require application-level changes.
* **Listener `allowedRoutes` guardrails matter.** The external gateway only accepts HTTPS routes from other namespaces; HTTP attachments are limited to the gateway namespace. Be mindful of those restrictions when creating new routes or debugging why a manifest is ignored.

## 🏠 Private Applications

`k8s_gateway` will provide DNS resolution to Kubernetes entrypoints from any device that uses your home DNS server.
For this to work, your home DNS server must be configured to forward DNS queries for `${bootstrap_cloudflare_domain}` to `${bootstrap_k8s_gateway_addr}` instead of the upstream DNS server(s) it normally uses.
This is a form of **split DNS** (aka split-horizon DNS / conditional forwarding).

Internal/Private applications will access external and/or internal Cilium Gateway local/private IP(s) provided by k8s_gateway
