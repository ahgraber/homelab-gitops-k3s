---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
  namespace: networking
  annotations:
    metallb.universe.tf/address-pool: ingress
spec:
  interval: 15m
  chart:
    spec:
      # renovate: registryUrl=https://helm.traefik.io/traefik
      chart: traefik
      version: 20.8.0
      sourceRef:
        kind: HelmRepository
        name: traefik-charts
        namespace: flux-system
  maxHistory: 3
  install:
    timeout: 10m
    replace: true
    # crds: CreateReplace
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      remediateLastFailure: true
      retries: 3
      strategy: rollback
    cleanupOnFail: true
    # crds: CreateReplace
  uninstall:
    keepHistory: false
  values:
    image:
      name: traefik
      # defaults to appVersion
      tag: ""
    deployment:
      kind: DaemonSet
      annotations:
        reloader.stakater.com/search: "true"

    installCRDs: true

    ingressClass:
      enabled: true
      isDefaultClass: true

    experimental:
      v3:
        enabled: false
      plugins:
        enabled: true
        # cloudflarewarp:
        #   modulename: github.com/BetterCorp/cloudflarewarp
        #   version: v1.3.0
      kubernetesGateway:
        enabled: false

    ingressRoute:
      dashboard:
        enabled: false # we'll use a custom ingressRoute with basic auth instead of the default one

    providers:
      kubernetesCRD:
        enabled: true
        allowCrossNamespace: true
        allowExternalNameServices: true
        # ingressClass: "traefikcrd"
        # ingressClass: traefik-internal
        # labelSelector: environment=production,method=traefik
      kubernetesIngress:
        enabled: true
        # ingressClass: "traefik"
        # ingressClass: traefik-internal
        # labelSelector: environment=production,method=traefik

    logs:
      general:
        level: DEBUG
        # format: json
      access:
        enabled: true # handled in crds kustomization
        # format: json
    metrics:
      prometheus:
        entryPoint: metrics
        addEntryPointsLabels: true
        addRoutersLabels: true
        addServicesLabels: true
    # tracing: {}

    ## https://doc.traefik.io/traefik/reference/static-configuration/cli/
    globalArguments:
      - "--global.checknewversion=false"
      - "--global.sendanonymoususage=false"
    additionalArguments:
      - "--api=true"
      # - "--api.dashboard=true"
      - "--api.debug=true"
      - "--api.insecure=true"
      - "--hostresolver=true"
      - "--serverstransport.insecureskipverify=true"
      ## add plugins
      - "--experimental.plugins.cloudflarewarp.modulename=github.com/bettercorp/cloudflarewarp"
      - "--experimental.plugins.cloudflarewarp.version=v1.3.0"
    env:
      - name: TZ
        value: "${TIMEZONE}"
    # envFrom: []
    #   - configMapRef:
    #       name: config-map-name
    #   - secretRef:
    #       name: secret-name

    ports:
      traefik:
        port: 9000
        expose: true # use ingressroute
        exposedPort: 9000
      web:
        # port: 80
        expose: true
        exposedPort: 80
        redirectTo: websecure
      websecure:
        # asDefault: true
        # port: 443
        expose: true
        exposedPort: 443
        ## Trust forwarded  headers information (X-Forwarded-*).
        forwardedHeaders:
          # insecure: false
          trustedIPs:
            ## rfc1918
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
            # ## https://www.cloudflare.com/ips-v4
            # - 173.245.48.0/20
            # - 103.21.244.0/22
            # - 103.22.200.0/22
            # - 103.31.4.0/22
            # - 141.101.64.0/18
            # - 108.162.192.0/18
            # - 190.93.240.0/20
            # - 188.114.96.0/20
            # - 197.234.240.0/22
            # - 198.41.128.0/17
            # - 162.158.0.0/15
            # - 104.16.0.0/13
            # - 104.24.0.0/14
            # - 172.64.0.0/13
            # - 131.0.72.0/22
            # ## https://www.cloudflare.com/ips-v6
            # - 2400:cb00::/32
            # - 2606:4700::/32
            # - 2803:f800::/32
            # - 2405:b500::/32
            # - 2405:8100::/32
            # - 2a06:98c0::/29
            # - 2c0f:f248::/32
        ## Enable the Proxy Protocol header parsing for the entry point
        # proxyProtocol:
        #   insecure: false
        #   trustedIPs: []
        tls:
          enabled: true
          options: "default"
      metrics:
        port: 9100
        expose: false
        # exposedPort: 9100

    # # https://doc.traefik.io/traefik/https/tls/#tls-options
    tlsOptions:
      default:
        minVersion: VersionTLS12
        maxVersion: VersionTLS13
        sniStrict: true
        cipherSuites:
          - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 # TLS 1.2
          - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305 # TLS 1.2
          - TLS_AES_256_GCM_SHA384 # TLS 1.3
          - TLS_CHACHA20_POLY1305_SHA256 # TLS 1.3
        curvePreferences:
          - CurveP521
          - CurveP384

    # TLS Store are created as TLSStore CRDs. This is useful if you want to set a default certificate
    # https://doc.traefik.io/traefik/https/tls/#default-certificate
    tlsStore:
      default:
        defaultCertificate:
          secretName: "${SECRET_DOMAIN/./-}-tls"

    service:
      enabled: true
      # 'single' service uses `MixedProtocolLBService` feature -- if false, creates two Service, one each for TCP+UDP
      single: true
      type: LoadBalancer
      ### pick either metallb annotation OR spec.loadBalancerIP
      annotations:
        metallb.universe.tf/loadBalancerIPs: "${LB_INGRESS}"
      # spec:
      #   # externalTrafficPolicy: Cluster
      #   loadBalancerIP: "${LB_INGRESS}" # metallb IP reservation for Ingress

    rbac:
      enabled: true

    resources:
      requests:
        cpu: 15m
        memory: 50M
      limits:
        memory: 105M

    tolerations:
      - key: "node-role.kubernetes.io/master"
        operator: "Exists"
