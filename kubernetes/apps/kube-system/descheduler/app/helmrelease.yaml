---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app descheduler
spec:
  chart:
    spec:
      chart: *app
      version: 0.35.0
      sourceRef:
        kind: HelmRepository
        name: *app
  interval: 1h
  values:
    kind: Deployment
    replicas: 2
    leaderElection:
      enabled: true
      leaseDuration: 15s
      renewDeadline: 10s
      retryPeriod: 2s
      resourceLock: leases
      resourceName: descheduler
      resourceNamescape: default
    deschedulerPolicy:
      maxNoOfPodsToEvictPerNode: 2
      maxNoOfPodsToEvictTotal: 10
      profiles:
        - name: Default
          pluginConfig:
            - name: DefaultEvictor
              args:
                evictFailedBarePods: true
                evictLocalStoragePods: true
                evictSystemCriticalPods: true
                nodeFit: true
            - name: LowNodeUtilization
              args:
                thresholds:
                  memory: 30
                targetThresholds:
                  memory: 70
                evictionLimits:
                  node: 1
                evictableNamespaces:
                  exclude:
                    - kube-system
                    - flux-system
                    - rook-ceph
                    - openebs-system
            # - name: RemoveFailedPods
            #   args:
            #     reasons:
            #       - ContainerStatusUnknown
            #       - NodeAffinity
            #       - NodeShutdown
            #       - Terminated
            #       - UnexpectedAdmissionError
            #     includingInitContainers: true
            #     excludeOwnerKinds:
            #       - Job
            #     minPodLifetimeSeconds: 1800
            - name: RemovePodsViolatingInterPodAntiAffinity
            - name: RemovePodsViolatingNodeAffinity
              args:
                nodeAffinityType:
                  - requiredDuringSchedulingIgnoredDuringExecution
            - name: RemovePodsViolatingNodeTaints
            - name: RemovePodsViolatingTopologySpreadConstraint
              args:
                constraints:
                  - DoNotSchedule
                  - ScheduleAnyway
          plugins:
            balance:
              enabled:
                - LowNodeUtilization
                - RemovePodsViolatingTopologySpreadConstraint
            deschedule:
              enabled:
                - RemovePodsViolatingInterPodAntiAffinity
                - RemovePodsViolatingNodeAffinity
                - RemovePodsViolatingNodeTaints

    resources:
      requests:
        cpu: 50m
        memory: 50M
      limits:
        memory: 105M

    service:
      enabled: true
    serviceMonitor:
      enabled: true
    annotations:
      reloader.stakater.com/search: "true"
    podAnnotations:
      configmap.reloader.stakater.com/reload: descheduler
    affinity:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values: [descheduler]
              topologyKey: kubernetes.io/hostname
    nodeSelector:
      node-role.kubernetes.io/control-plane: "true"
    tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
