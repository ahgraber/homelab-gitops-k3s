---
apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: grafana
spec:
  deployment:
    replicas: 1
    env:
      - name: GF_DATE_FORMATS_USE_BROWSER_LOCALE
        value: "true"
      - name: GF_DATE_FORMATS_FULL_DATE
        value: DD.MM.YYYY hh:mm:ss
      - name: GF_EXPLORE_ENABLED
        value: "true"
      - name: GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS
        value: natel-discrete-panel,pr0ps-trackmap-panel,panodata-map-panel
      - name: GF_SECURITY_ALLOW_EMBEDDING
        value: "true"
      - name: GF_SECURITY_ANGULAR_SUPPORT_ENABLED
        value: "true"
      - name: GF_SECURITY_COOKIE_SAMESITE
        value: grafana
      - name: GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: grafana-oidc
            key: client-secret
    strategy: RollingUpdate
  config:
    analytics:
      check_for_plugin_updates: false
      check_for_updates: false
      feedback_links_enabled: false
      reporting_enabled: false
    auth:
      oauth_allow_insecure_email_lookup: true
      oauth_auto_login: true
      signout_redirect_url: https://auth.${SECRET_DOMAIN}/logout
    auth.anonymous:
      enabled: false
    auth.basic:
      enabled: false
    auth.generic_oauth:
      api_url: https://auth.${SECRET_DOMAIN}/api/oidc/userinfo
      auth_url: https://auth.${SECRET_DOMAIN}/api/oidc/authorization
      client_id: grafana
      enabled: true
      empty_scopes: false
      groups_attribute_path: groups
      icon: signin
      login_attribute_path: preferred_username
      name: Authelia
      name_attribute_path: name
      scopes: openid profile email groups
      token_url: https://auth.${SECRET_DOMAIN}/api/oidc/token
      use_pkce: true
    auth.generic_oauth.group_mapping:
      org_id: 1
      role_attribute_path: |-
        contains(groups[*], 'admins') && 'Admin' || contains(groups[*], 'grafana:viewer') && 'Viewer' || 'Viewer'
    metrics:
      enabled: true
    news:
      news_feed_enabled: false
    plugins:
      plugin_admin_enabled: false
    security:
      angular_support_enabled: true
      cookie_samesite: grafana
    server:
      root_url: https://grafana.${SECRET_DOMAIN}
  datasourceNamespaceSelector: {}
  datasourceLabelSelector:
    - matchLabels:
        app.kubernetes.io/name: grafana
  dashboardNamespaceSelector: {}
  dashboardLabelSelector:
    - matchLabels:
        app.kubernetes.io/name: grafana
  ingress:
    enabled: false
  service:
    metadata:
      labels:
        app.kubernetes.io/name: grafana
    spec:
      ports:
        - name: http
          port: 3000
          targetPort: 3000
      type: ClusterIP
  plugins:
    - grafana-clock-panel
    - grafana-piechart-panel
    - grafana-worldmap-panel
    - natel-discrete-panel
    - pr0ps-trackmap-panel
    - vonage-status-panel
