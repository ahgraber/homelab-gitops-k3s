---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name authelia
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: *name
    template:
      data:
        AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD: '{{ index . "AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD" }}'
        AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET: '{{ index . "AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET" }}'
        AUTHELIA_STORAGE_ENCRYPTION_KEY: '{{ index . "AUTHELIA_STORAGE_ENCRYPTION_KEY" }}'
        ### oidc
        AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET: '{{ index . "AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET" }}'
        OIDC_JWKS_KEY: '{{ index . "OIDC_JWKS_KEY" }}'
        ### notification smtp settings
        SMTP_ADDRESS: 'smtp://{{ index . "SECRET_SMTP_HOST" }}:{{ index . "SECRET_SMTP_PORT" }}'
        SMTP_USERNAME: '{{ index . "SECRET_SMTP_USER" }}'
        SMTP_PASSWORD: '{{ index . "SECRET_SMTP_PWD" }}'
        SMTP_SENDER: 'Authelia <{{ index . "SECRET_SMTP_ADDRESS" }}>'
        ### client secrets
        CALIBRE_OAUTH_CLIENT_DIGEST: '{{ index . "CALIBRE_OAUTH_CLIENT_DIGEST" }}'
        FRESHRSS_OAUTH_CLIENT_DIGEST: '{{ index . "FRESHRSS_OAUTH_CLIENT_DIGEST" }}'
        GRAFANA_OAUTH_CLIENT_DIGEST: '{{ index . "GRAFANA_OAUTH_CLIENT_DIGEST" }}'
        JELU_OAUTH_CLIENT_DIGEST: '{{ index . "JELU_OAUTH_CLIENT_DIGEST" }}'
        KARAKEEP_OAUTH_CLIENT_DIGEST: '{{ index . "KARAKEEP_OAUTH_CLIENT_DIGEST" }}'
        MEALIE_OAUTH_CLIENT_DIGEST: '{{ index . "MEALIE_OAUTH_CLIENT_DIGEST" }}'
        MEMOS_OAUTH_CLIENT_DIGEST: '{{ index . "MEMOS_OAUTH_CLIENT_DIGEST" }}'
        SHELFMARK_OAUTH_CLIENT_DIGEST: '{{ index . "SHELFMARK_OAUTH_CLIENT_DIGEST" }}'
        WHOAMI_OAUTH_CLIENT_DIGEST: '{{ index . "WHOAMI_OAUTH_CLIENT_DIGEST" }}'
  dataFrom:
    - extract:
        # all available properties from the key will be synced
        key: "security.authelia"
    - extract:
        key: "shared.email-secrets"
