---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: redis
  namespace: &namespace default
spec:
  interval: 15m
  chart:
    spec:
      chart: redis-cluster
      version: 0.13.0
      sourceRef:
        kind: HelmRepository
        name: ot-charts
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    redisCluster:
      image: quay.io/opstree/redis
      tag: v7.0.5
      imagePullPolicy: IfNotPresent
      clusterVersion: v7
      clusterSize: 3

      redisSecret:
        secretName: redis-secret
        secretKey: password

      leader:
        replicas: 3
        serviceType: ClusterIP
        # affinity:
        #   podAntiAffinity:
        #     requiredDuringSchedulingIgnoredDuringExecution:
        #       - labelSelector:
        #           matchExpressions:
        #             - key: app
        #               operator: In
        #               values:
        #                 - redis-cluster-leader
        #         topologyKey: "kubernetes.io/hostname"
      follower:
        replicas: 3
        serviceType: ClusterIP
        # affinity:
        #   podAntiAffinity:
        #     requiredDuringSchedulingIgnoredDuringExecution:
        #       - labelSelector:
        #           matchExpressions:
        #             - key: app
        #               operator: In
        #               values:
        #                 - redis-cluster-follower
        #         topologyKey: "kubernetes.io/hostname"
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          memory: 512Mi

    externalConfig:
      enabled: false

    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: ceph-block
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 1Gi
      #   selector: {}

    # priorityClassName: "-"
    securityContext:
      runAsUser: 1000
      fsGroup: 1000

    # If redis service needs to be exposed using LoadBalancer or NodePort
    externalService:
      enabled: false

    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
      namespace: monitoring

    redisExporter:
      enabled: true
      # image: quay.io/opstree/redis-exporter
      imagePullPolicy: IfNotPresent
      resources: # for redis exporter
        limits:
          memory: 128Mi
        requests:
          cpu: 100m
          memory: 128Mi
      # env: # for redis exporter
      # - name: REDIS_EXPORTER_INCL_SYSTEM_METRICS
      #   value: "true"
      # - name: UI_PROPERTIES_FILE_NAME
      #   valueFrom:
      #     configMapKeyRef:
      #       name: game-demo
      #       key: ui_properties_file_name
      # - name: SECRET_USERNAME
      #   valueFrom:
      #     secretKeyRef:
      #       name: mysecret
      #       key: username

    nodeSelector: {}
    affinity: {}
