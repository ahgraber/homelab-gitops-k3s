---
# yaml-language-server: $schema=https://raw.githubusercontent.com/PrefectHQ/prefect-helm/main/charts/prefect-server/values.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app prefect-server
spec:
  chart:
    spec:
      chart: *app
      version: 2025.10.16183503
      sourceRef:
        kind: HelmRepository
        name: prefect
  interval: 1h
  values:
    global:
      prefect:
        image:
          repository: prefecthq/prefect
          prefectTag: 3-python3.12-kubernetes

    server:
      debug: true

      uiConfig:
        # to connect to the UI from somewhere external to the cluster (i.e. via an ingress), set this value to the ingress URL
        prefectUiApiUrl: "https://prefect.${SECRET_DOMAIN}/api"

      replicaCount: 1

      autoscaling:
        enabled: false
        minReplicas: 1
        maxReplicas: 3
        targetCPU: 80
        targetMemory: 80

      resources:
        requests:
          cpu: 500m
          memory: 512Mi
        limits:
          memory: 1Gi

      ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-pod
      podSecurityContext:
        runAsUser: 1000
        runAsNonRoot: true
        fsGroup: 1002
      ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/security-context/#set-the-security-context-for-a-container
      containerSecurityContext:
        runAsUser: 1000
        runAsNonRoot: true
        readOnlyRootFilesystem: true
        allowPrivilegeEscalation: false

    ## Service configuration
    service:
      type: ClusterIP
      port: 4200
      targetPort: 4200

    ingress:
      enabled: false

    # Database migrations configuration
    migrations:
      enabled: true
      backoffLimit: 5
      timeoutSeconds: 300
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi

    # External PostgreSQL configuration
    # https://discourse.prefect.io/t/how-to-use-external-postgres-when-deploy-by-helm-chart/2501/4
    postgresql:
      enabled: false

    secret:
      create: true
      # ... filled with valuesFrom below
      port: 5432
