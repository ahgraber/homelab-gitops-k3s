---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: cockroachdb-source
  namespace: flux-system
spec:
  interval: 30m
  # renovate: datasource=github-releases
  url: https://github.com/cockroachdb/cockroach-operator.git
  ref:
    tag: v2.6.0
  ignore: |
    # exclude all
    /*
    # include install dir with crds
    !/install
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: cockroachdb-crds
  namespace: flux-system
spec:
  interval: 15m
  prune: false
  # wait: true
  sourceRef:
    kind: GitRepository
    name: cockroachdb-source

  # ref: https://github.com/kubernetes-sigs/kustomize/blob/master/examples/inlinePatch.md
  # ref: https://fluxcd.io/docs/components/kustomize/api/
  patches:
    - target:
        version: v1
        kind: Namespace
        name: cockroach-operator-system
      patch: |-
        kind: Namespace
        metadata:
          name: cockroach-operator-system
          labels:
            control-plane: cockroach-operator
            goldilocks.fairwinds.com/enabled: "true"

    - target:
        group: apps
        version: v1
        kind: Deployment
        name: cockroach-operator-manager
        namespace: cockroach-operator-system
      patch: |-
        - op: add
          path: "/spec/template/spec/containers/args/-"
          value: "-feature-gates=TolerationRules=true,AffinityRules=true,TopologySpreadRules=true"
