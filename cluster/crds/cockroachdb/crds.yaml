---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: cockroachdb-source
  namespace: flux-system
spec:
  interval: 30m
  # renovate: datasource=github-releases
  url: https://github.com/cockroachdb/cockroach-operator.git
  ref:
    tag: v2.6.0
  ignore: |
    # exclude all
    /*
    # include install dir with crds
    !/install
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: cockroachdb-crds
  namespace: flux-system
spec:
  interval: 15m
  prune: false
  # wait: true
  sourceRef:
    kind: GitRepository
    name: cockroachdb-source

  # ref: https://github.com/kubernetes-sigs/kustomize/blob/master/examples/inlinePatch.md
  # ref: https://fluxcd.io/docs/components/kustomize/api/
  patches:
    # add goldlilocks label to namespace
    - target:
        kind: Namespace
        name: cockroach-operator-system
      patch: |-
        apiVersion: v1
        kind: Namespace
        metadata:
          name: cockroach-operator-system
          labels:
            goldilocks.fairwinds.com/enabled: "true"

    # enable feature gates for topology
    # ref: https://www.cockroachlabs.com/docs/v21.2/schedule-cockroachdb-kubernetes.html#enable-feature-gates
    - target:
        kind: Deployment
        name: cockroach-operator-manager
        namespace: cockroach-operator-system
      patch: |-
        - op: add
          path: "/spec/template/spec/containers/0/args/-"
          value: "-feature-gates=TolerationRules=true,AffinityRules=true,TopologySpreadRules=true"
