---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: GitRepository
metadata:
  name: cockroachdb-source
  namespace: flux-system
spec:
  interval: 30m
  # renovate: datasource=github-releases
  url: https://github.com/cockroachdb/cockroach-operator.git
  ref:
    tag: v2.6.0
  ignore: |
    # exclude all
    /*
    # include install dir with crds
    !/install
---
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: cockroachdb-crds
  namespace: flux-system
spec:
  interval: 15m
  prune: false
  # wait: true
  sourceRef:
    kind: GitRepository
    name: cockroachdb-source

# ref: https://github.com/kubernetes-sigs/kustomize/blob/master/examples/inlinePatch.md
patchesJSON6902:
  # enable feature-gates for topology & tolerations
  # ref: https://www.cockroachlabs.com/docs/v21.2/schedule-cockroachdb-kubernetes.html#enable-feature-gates
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: cockroach-operator-manager
      namespace: cockroach-operator-system
    patch: |-
      - op: add
        path: "/spec/template/spec/containers/args/-"
        value: "-feature-gates=TolerationRules=true,AffinityRules=true,TopologySpreadRules=true"
