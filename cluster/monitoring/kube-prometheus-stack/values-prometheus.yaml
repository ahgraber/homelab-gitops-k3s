---
apiVersion: v1
kind: ConfigMap
metadata:
  name: values-prometheus
  namespace: monitoring
data:
  values.yaml: |
    ## Deploy a Prometheus instance
    prometheus:
      enabled: true
      nameOverride: prometheus

      ingress:
        enabled: false # see ingressRoute

      ## Settings affecting prometheusSpec
      ## ref: https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/api.md#prometheusspec
      prometheusSpec:
        replicas: 1
        replicaExternalLabelName: __replica__

        enableAdminAPI: true
        logLevel: info

        ## External URL at which Prometheus will be reachable.
        # externalUrl: "https://prometheus.${SECRET_DOMAIN}""

        ## Interval between consecutive scrapes. Default 30s.
        scrapeInterval: ""
        scrapeTimeout: ""

        ## If true, a nil or {} value for prometheus.prometheusSpec.___Selector will cause the
        ## prometheus resource to be created with selectors based on values in the helm deployment,
        ## which will also match the Prometheus___resources created
        ruleSelectorNilUsesHelmValues: false
        serviceMonitorSelectorNilUsesHelmValues: false
        podMonitorSelectorNilUsesHelmValues: false
        probeSelectorNilUsesHelmValues: false

        ## retention & compression
        retention: 3d
        retentionSize: 6GiB
        walCompression: true

        ## Prometheus StorageSpec for persistent data
        ## ref: https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/storage.md
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: ceph-block
              resources:
                requests:
                  storage: 10Gi
              ## for attaching retained PV
              # selector:
              #   matchLabels:
              #     app.kubernetes.io/instance: kps-prometheus
              #     app.kubernetes.io/name: prometheus

        # tolerations: []
        # nodeSelector: {}
        podAntiAffinity: hard
        podAntiAffinityTopologyKey: kubernetes.io/hostname

        ## Resource limits & requests
        resources:
          requests:
            cpu: 763m
            memory: 7Gi
          limits:
            memory: 7Gi

        ## AdditionalScrapeConfigs allows specifying additional Prometheus scrape configurations.
        ## Scrape configurations are appended to the configurations generated by the Prometheus Operator.
        ## Job configurations must have the form as specified in the official Prometheus documentation:
        ## https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config.
        ## As scrape configs are appended, the user is responsible to make sure it is valid.
        ## Note that using this feature may expose the possibility to break upgrades of Prometheus.
        ## It is advised to review Prometheus release notes to ensure that no incompatible scrape configs are going to break Prometheus after the upgrade.
        ## AdditionalScrapeConfigs can be defined as a list or as a templated string.
        additionalScrapeConfigs:
          - job_name: opnsense
            honor_timestamps: true
            static_configs:
              - targets:
                  - "opnsense.${SECRET_DOMAIN}:9100"
          - job_name: truenas-minio
            bearer_token: eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJleHAiOjQ4MDUxODEzODIsImlzcyI6InByb21ldGhldXMiLCJzdWIiOiJadGdROWdHcmJ3RUNaOGt4WlJRbyJ9.W1oCrRnCbP3SJCGiT1I5yrfAYqhO4coehQqWUduF8DLXKhOStS3LteNrPCPn5fodjWHydu_BILwkc6AhOwWe9g
            metrics_path: /minio/v2/metrics/node
            scheme: https
            static_configs:
              - targets:
                  - "${SECRET_S3_ENDPOINT}"
          # - job_name: crunchy-postgres-exporter
          #   kubernetes_sd_configs:
          #     - role: pod
          #   relabel_configs:
          #     - source_labels: [__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_crunchy_postgres_exporter,__meta_kubernetes_pod_label_crunchy_postgres_exporter]
          #       action: keep
          #       regex: true
          #       separator: ""
          #     - source_labels: [__meta_kubernetes_pod_container_port_number]
          #       action: drop
          #       regex: 5432
          #     - source_labels: [__meta_kubernetes_pod_container_port_number]
          #       action: drop
          #       regex: 10000
          #     - source_labels: [__meta_kubernetes_pod_container_port_number]
          #       action: drop
          #       regex: 8009
          #     - source_labels: [__meta_kubernetes_pod_container_port_number]
          #       action: drop
          #       regex: 2022
          #     - source_labels: [__meta_kubernetes_pod_container_port_number]
          #       action: drop
          #       regex: ^$
          #     - source_labels: [__meta_kubernetes_namespace]
          #       action: replace
          #       target_label: kubernetes_namespace
          #     - source_labels: [__meta_kubernetes_pod_name]
          #       target_label: pod
          #     - source_labels: [__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_cluster,__meta_kubernetes_pod_label_pg_cluster]
          #       target_label: cluster
          #       separator: ""
          #       replacement: '$1'
          #     - source_labels: [__meta_kubernetes_namespace,cluster]
          #       target_label: pg_cluster
          #       separator: ":"
          #       replacement: '$1$2'
          #     - source_labels: [__meta_kubernetes_pod_ip]
          #       target_label: ip
          #       replacement: '$1'
          #     - source_labels: [__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_instance,__meta_kubernetes_pod_label_deployment_name]
          #       target_label: deployment
          #       replacement: '$1'
          #       separator: ""
          #     - source_labels: [__meta_kubernetes_pod_label_postgres_operator_crunchydata_com_role,__meta_kubernetes_pod_label_role]
          #       target_label: role
          #       replacement: '$1'
          #       separator: ""
          #     - source_labels: [dbname]
          #       target_label: dbname
          #       replacement: '$1'
          #     - source_labels: [relname]
          #       target_label: relname
          #       replacement: '$1'
          #     - source_labels: [schemaname]
          #       target_label: schemaname
          #       replacement: '$1'

        thanos:
          image: quay.io/thanos/thanos:v0.29.0
          # renovate: datasource=docker depName=quay.io/thanos/thanos
          version: "v0.29.0"
          objectStorageConfig:
            name: thanos-objstore-secret
            key: objstore.yml

      thanosService:
        enabled: true
      thanosServiceMonitor:
        enabled: true
      thanosServiceExternal:
          enabled: false
      thanosIngress:
        enabled: false
