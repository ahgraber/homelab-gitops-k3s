---
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: democratic-csi-driver-config-nfs-secret
  namespace: democratic-csi
  # labels:
  #   app.kubernetes.io/name: {{ include "democratic-csi.name" . }}
  #   helm.sh/chart: {{ include "democratic-csi.chart" . }}
  #   app.kubernetes.io/instance: {{ .Release.Name }}
  #   app.kubernetes.io/managed-by: {{ .Release.Service }}
stringData:
  driver-config-file.yaml: |-
    driver: freenas-api-nfs
    ## generate guid `uuidgen` per helm release
    instance_id: B8712266-C1B5-4DCD-9DFD-C6646C0AD3A4
    httpConnection:
      protocol: http
      host: "${TRUENAS_IP}"
      port: 80
      # use only 1 of apiKey or username/password
      # if both are present, apiKey is preferred
      # apiKey is only available starting in TrueNAS-12
      apiKey: "${TRUENAS_APIKEY}"
      # username: ${TRUENAS_USER}
      # password:
      allowInsecure: true
      # use apiVersion 2 for TrueNAS-12 and up (will work on 11.x in some scenarios as well)
      # leave unset for auto-detection
      #apiVersion: 2
    # sshConnection:
    #   host: "${TRUENAS_IP}"
    #   port: 22
    #   username: ${TRUENAS_USER}
    #   # use either password or key
    #   # password: ""
    #   privateKey: |
    #     ${TRUENAS_SSHKEY}
    zfs:
      cli:
        ## allow non-root user to sudo
        sudoEnabled: true
      ## leave paths unset for auto-detection
      #  paths:
      #   zfs: /usr/local/sbin/zfs
      #   zpool: /usr/local/sbin/zpool
      #   sudo: /usr/local/bin/sudo
      #   chroot: /usr/sbin/chroot

      # can be used to set arbitrary values on the dataset/zvol
      # can use handlebars templates with the parameters from the storage class/CO
      datasetProperties:
        "org.freenas:description": "flux-{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"

      # total volume name (zvol/<datasetParentName>/<pvc name>) length cannot exceed 63 chars
      # https://www.ixsystems.com/documentation/freenas/11.2-U5/storage.html#zfs-zvol-config-opts-tab
      # standard volume naming overhead is 46 chars
      # datasetParentName should therefore be 17 chars or less
      datasetParentName: ssdpool/csi/nfs/v
      ## do NOT make datasetParentName and detachedSnapshotsDatasetParentName overlap
      ## they may be siblings, but neither should be nested in the other
      detachedSnapshotsDatasetParentName: ssdpool/csi/nfs/s
      datasetEnableQuotas: true
      datasetEnableReservation: false
      ## Set dataset permissions appropriately on TrueNAS
      datasetPermissionsMode: "0777"
      datasetPermissionsUser: "${TRUENAS_USER}"
      datasetPermissionsGroup: "www-data"
      #datasetPermissionsAcls:
      #- "-m everyone@:full_set:allow"
      #- "-m u:kube:full_set:allow"

    nfs:
      shareHost: "${TRUENAS_IP}"
      shareAlldirs: false
      shareAllowedHosts: []
      shareAllowedNetworks: []
      ## Set dataset permissions appropriately on TrueNAS
      shareMaprootUser: "${TRUENAS_USER}"
      shareMaprootGroup: "www-data"
      shareMapallUser: ""
      shareMapallGroup: ""
