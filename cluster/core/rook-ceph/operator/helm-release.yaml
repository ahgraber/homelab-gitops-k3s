---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: rook-ceph-operator
  namespace: rook-ceph
spec:
  interval: 15m
  chart:
    spec:
      # renovate: registryUrl=https://charts.rook.io/release
      chart: rook-ceph
      version: v1.10.0
      sourceRef:
        kind: HelmRepository
        name: rook-ceph-charts
        namespace: flux-system
  values:
    crds:
      enabled: false
    monitoring:
      enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 256Mi

    tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/master
        operator: Exists
    nodeSelector:
      node-role.kubernetes.io/master: "true"

    csi:
      enableRbdDriver: true
      enableCephfsDriver: true
      enableGrpcMetrics: false
      enableCSIHostNetwork: true
      enableCephfsSnapshotter: true
      enableRBDSnapshotter: true
      enablePluginSelinuxHostMount: false
      enableCSIEncryption: false

      kubeletDirPath: /var/lib/kubelet

      # Set provisonerTolerations and provisionerNodeAffinity for provisioner pod.
      # The CSI provisioner would be best to start on the same nodes as other ceph daemons.
      provisionerTolerations:
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
      # provisionerNodeAffinity: node-role.kubernetes.io/master=true
      # Set pluginTolerations and pluginNodeAffinity for plugin daemonset pods.
      # The CSI plugins need to be started on all the nodes where the clients need to mount the storage.
      pluginTolerations:
        - effect: "NoExecute"
          operator: "Exists"
        - effect: "NoSchedule"
          operator: "Exists"
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
      # pluginNodeAffinity: node-role.kubernetes.io/master=true

    admissionController:
      tolerations:
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
      nodeAffinity: node-role.kubernetes.io/master=true
