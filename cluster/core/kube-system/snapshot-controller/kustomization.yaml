---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - helm-release.yaml # use direct github link instead
#   - github.com/kubernetes-csi/external-snapshotter//deploy/kubernetes/snapshot-controller?ref=v6.0.1
# images:
#   - name: gcr.io/k8s-staging-sig-storage/snapshot-controller
#     newTag: v6.0.1
# patchesStrategicMerge:
#   - |-
#     kind: Deployment
#     apiVersion: apps/v1
#     metadata:
#       name: snapshot-controller
#       namespace: kube-system
#     spec:
#       # replicas: 3
#       template:
#         spec:
#           containers:
#             - name: snapshot-controller
#               args:
#                 - "--v=5"
#                 - "--leader-election=true"
#                 - "--enable-distributed-snapshotting"

#               resources:
#                 requests:
#                   cpu: 15m
#                   memory: 64M
#                 limits:
#                   memory: 64M

#           tolerations:
#             - effect: NoSchedule
#               key: node-role.kubernetes.io/master
#               operator: Exists
#           nodeSelector:
#             node-role.kubernetes.io/master: "true"

patches:
  # Enable this RBAC rule only when using distributed snapshotting, i.e. when the enable-distributed-snapshotting flag is set to true
  - target:
      kind: ClusterRole
      name: snapshot-controller-runner
    patch: |-
      - op: add
        path: '/rules/-'
        value: { apiGroups: [""], resources: ["nodes"], verbs: ["get", "list", "watch"] }
