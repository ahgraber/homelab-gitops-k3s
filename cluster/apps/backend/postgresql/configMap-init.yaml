apiVersion: v1
metadata:
  annotations:
    meta.helm.sh/release-name: postgresql
    meta.helm.sh/release-namespace: postgresql
  name: configmap-postgresql-init
  namespace: postgresql
kind: ConfigMap
data:
  testsvc.sh: |
    #!/bin/bash
    export ROOT_PWD="${SECRET_DB_ROOT_PWD}"
    export USER_PWD="${SECRET_DB_USER_PWD}"
    # echo "ROOT_PWD=$ROOT_PWD"
    # echo "USER_PWD=$USER_PWD"

    function initdb {
      echo "Creating \"$1\" user and database"

      # note: if this presents problems in the future, look into heredoc indentations
      psql "postgresql://postgres:$ROOT_PWD@localhost:5432" -e <<EOSQL
    CREATE USER $1 WITH LOGIN PASSWORD '$USER_PWD';
    CREATE DATABASE "$1";
    GRANT ALL PRIVILEGES ON DATABASE "$1" TO "$1";
    EOSQL
    }

    # initialize users + databases
    initdb "vaultwarden"
    initdb "authentik"
    # initdb "mealie"
