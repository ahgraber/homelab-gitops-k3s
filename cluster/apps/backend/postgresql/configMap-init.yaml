apiVersion: v1
metadata:
  annotations:
    meta.helm.sh/release-name: postgresql
    meta.helm.sh/release-namespace: postgresql
  name: configmap-postgresql-init
  namespace: postgresql
kind: ConfigMap
data:
  testsvc.sh: |
    #!/bin/bash
    # # check if socket is initialized (only happens on first boot)
    # # ref: https://github.com/bitnami/charts/issues/1395#issuecomment-578066552
    # if [[ -S /opt/bitnami/mariadb/tmp/mysql.sock ]]; then
    #   echo "Running DB initialization..."
    # else
    #   echo "Not first boot, skipping initialization. Exiting..."
    #   exit 0
    # fi

    export ROOT_PWD="${DB_ROOT_PWD}"
    export USER_PWD="${DB_USER_PWD}"
    # echo "ROOT_PWD=$ROOT_PWD"
    # echo "USER_PWD=$USER_PWD"

    function initdb {
      echo "Creating \"$1\" user and database"

      # note: if this presents problems in the future, look into heredoc indentations
      psql "postgresql://postgres:$ROOT_PWD@localhost:5432" -e <<EOSQL
    CREATE USER $1 WITH LOGIN PASSWORD '$USER_PWD';
    CREATE DATABASE "$1";
    GRANT ALL PRIVILEGES ON DATABASE "$1" TO "$1";
    EOSQL
    }

    # CREATE USER "$1" IDENTIFED BY '$USER_PWD';
    # CREATE USER $1 WITH ENCRYPTED PASSWORD '$USER_PWD';

    # initialize users + databases
    initdb "vaultwarden"
