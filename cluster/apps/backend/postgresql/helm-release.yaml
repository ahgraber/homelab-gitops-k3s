---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: postgresql
  namespace: postgresql
spec:
  interval: 10m
  timeout: 10m  # extended period because of lengthy startup
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: postgresql
      version: 10.9.4
      sourceRef:
        kind: HelmRepository
        name: bitnami-charts
        namespace: flux-system
  values:
    image:
      debug: true

    replication:
      enabled: false
      # user: repl_user
      # password: ${SECRET_DB_ROOT_PWD}

    global:
      postgresql:
        # postgresqlPassword: ${SECRET_DB_ROOT_PWD}
        # replicationPassword: ${SECRET_DB_ROOT_PWD}
        existingSecret: "secret-postgresql"

    # postgresqlUsername: postgres
    # postgresqlPassword: ${SECRET_DB_ROOT_PWD}
    # postgresqlPostgresPassword: ${SECRET_DB_ROOT_PWD}
    ## NOTE: When it's set the other auth/password parameters are ignored.
    ## Use existing secret (ignores postgresqlUsername, postgresqlPassword, and replication.password)
    # existingSecret: "secret-postgresql"

    # settings to archive Write Ahead Log for incremental backups
    # postgresqlExtendedConf: {}

    # pgHbaConfiguration: |
    #   host     all             all         0.0.0.0/0          md5
    #   host     all             all         ::/0               md5
    #   local    all             all                            md5
    #   host     all             all         127.0.0.1/32       md5
    #   host     all             all         ::1/128            md5
    #   host     all             all         0.0.0.0/0          md5

    #   host     replication     postgres    0.0.0.0/0          md5
    #   host     replication     postgres    ::/0               md5
    #   local    replication     postgres                       md5
    #   host     replication     postgres    127.0.0.1/32       md5
    #   host     replication     postgres    ::1/128            md5
    #   host     replication     postgres    0.0.0.0/0          md5

    configurationConfigMap: "configmap-postgresql-conf"
    initdbScriptsConfigMap: "configmap-postgresql-init"
    # initdbUser:
    # initdbPassword:

    service:
      ## Kubernetes service type and port number
      # type: ClusterIP
      type: LoadBalancer
      loadBalancerIP: ${METALLB_POSTGRES}
      port: 5432

    persistence:
      enabled: true
      existingClaim: data-postgresql-postgresql-0
      # storageClass: "csi-truenas-iscsi"
      # size: 8Gi

    ## An array to add extra environment variables
    extraEnv:
      - name: TZ
        value: "America/New_York"


    primary:
      podAnnotations:
        secret.reloader.stakater.com/reload: "secret-postgresql"

      extraVolumes:
        - name: backup
          persistentVolumeClaim:
            claimName: backup-postgresql
      extraVolumeMounts:
        - name: backup
          mountPath: /mnt/backup
          # mountPath: /bitnami/mariadb/backup

    serviceAccount:
      create: true

    # rbac:
    #   create: true

    volumePermissions:
      enabled: false

    metrics:
      enabled: false