apiVersion: v1
metadata:
  annotations:
    # meta.helm.sh/release-name: mariadb-galera
    meta.helm.sh/release-namespace: mariadb
  name: init-configmap-mariadb
  namespace: mariadb
kind: ConfigMap
data:
  # testsvc.sql: |
  #     CREATE USER \"$SERVICE\"@'%' IDENTIFIED VIA mysql_native_password USING \"$USER_PWD\";
  #     GRANT USAGE ON *.* TO \"$SERVICE\"@'% REQUIRE NONE WITH MAX_QUERIES_PER_HOUR 0 MAX_CONNECTIONS_PER_HOUR 0 MAX_UPDATES_PER_HOUR 0 MAX_USER_CONNECTIONS 0;
  #     CREATE DATABASE IF NOT EXISTS `$SERVICE`;
  #     GRANT ALL PRIVILEGES ON `$SERVICE`.* TO \"$SERVICE\"@'%';
  testsvc.sh: |
    #!/bin/sh
    if [[ $(hostname) == *-0  ]]; then
      echo "Check if mysql is running"
      ps -ef | grep mysql

      echo "Installing on 0th node"

      export SERVICE=testsvc
      export ROOT_PWD=${DB_ROOT_PWD}
      export USER_PWD=${DB_USER_PWD}

      echo "ROOT_PWD=$ROOT_PWD"
      echo "USER_PWD=$USER_PWD"

      echo "Creating '$SERVICE' user and database"
      # note: if this presents problems in the future, look into heredoc indentations
      mysql --port=3306 --user=root --password="$ROOT_PWD" -v --execute=<<EOF
    CREATE USER '$SERVICE'@'%' IDENTIFIED VIA mysql_native_password USING '$USER_PWD';
    GRANT USAGE ON *.* TO '$SERVICE'@'%' REQUIRE NONE WITH MAX_QUERIES_PER_HOUR 0 MAX_CONNECTIONS_PER_HOUR 0 MAX_UPDATES_PER_HOUR 0 MAX_USER_CONNECTIONS 0;
    CREATE DATABASE IF NOT EXISTS `$SERVICE`;
    GRANT ALL PRIVILEGES ON `$SERVICE`.* TO '$SERVICE'@'%';
    EOF
    else
      echo "Skipping install as not 0th node"
    fi