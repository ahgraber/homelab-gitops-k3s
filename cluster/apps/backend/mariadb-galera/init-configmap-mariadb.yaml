apiVersion: v1
metadata:
  annotations:
    # meta.helm.sh/release-name: mariadb-galera
    meta.helm.sh/release-namespace: mariadb
  name: init-configmap-mariadb
  namespace: mariadb
kind: ConfigMap
data:
  # testsvc.sql: |
  #   CREATE USER 'testsvc'@'%' IDENTIFIED VIA mysql_native_password USING '1234!';
  #   GRANT USAGE ON *.* TO 'testsvc'@'%' REQUIRE NONE WITH MAX_QUERIES_PER_HOUR 0 MAX_CONNECTIONS_PER_HOUR 0 MAX_UPDATES_PER_HOUR 0 MAX_USER_CONNECTIONS 0;
  #   CREATE DATABASE IF NOT EXISTS `testsvc`;
  #   GRANT ALL PRIVILEGES ON `testsvc`.* TO 'testsvc'@'%';
  testsvc.sh: |
    #!/bin/sh
    # check if socket is initialized (only happens on first boot)
    # ref: https://github.com/bitnami/charts/issues/1395#issuecomment-578066552
    if [[ -S /opt/bitnami/mariadb/tmp/mysql.sock ]]; then
      echo "Running DB initialisation..."
    else
      echo "Not running initialisation, exiting..."
      exit 0
    fi

    if [[ $(hostname) == *-0  ]]; then
      echo "Check if mysql is running"
      ps -ef | grep mysql

      echo "Installing on 0th node"

      export SERVICE=testsvc
      export ROOT_PWD=${DB_ROOT_PWD}
      export USER_PWD=${DB_USER_PWD}

      echo "ROOT_PWD=$ROOT_PWD"
      echo "USER_PWD=$USER_PWD"

      echo "Creating '$SERVICE' user and database"
      # note: if this presents problems in the future, look into heredoc indentations
      /opt/bitnami/mariadb/bin/mysql --port=3306 --user="root" --password="$ROOT_PWD" -v <<EOSQL
      CREATE USER '$SERVICE'@'%' IDENTIFIED VIA mysql_native_password USING '$USER_PWD';
      GRANT USAGE ON *.* TO '$SERVICE'@'%' REQUIRE NONE WITH MAX_QUERIES_PER_HOUR 0 MAX_CONNECTIONS_PER_HOUR 0 MAX_UPDATES_PER_HOUR 0 MAX_USER_CONNECTIONS 0;
      CREATE DATABASE IF NOT EXISTS `$SERVICE`;
      GRANT ALL PRIVILEGES ON `$SERVICE`.* TO '$SERVICE'@'%';
    EOSQL
    else
      echo "Skipping install as not 0th node"
    fi
