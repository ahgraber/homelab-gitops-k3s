---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: security
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://oauth2-proxy.github.io/manifests
      chart: oauth2-proxy
      version: 4.2.2
      sourceRef:
        kind: HelmRepository
        name: oauth2-proxy-charts
        namespace: flux-system
  values:
    service:
      type: ClusterIP
      portNumber: 80

    ingress:
      enabled: false
      hostname: oauth2-proxy.${SECRET_DOMAIN}
      path: /

    proxyVarsAsSecrets: true
    config:
      clientID: k8s
      clientSecret: ${SECRET_OAUTH2PROXY_SECRET}
      cookieSecret: ${SECRET_OAUTH2PROXY_COOKIE}
      ## ConfigMap with the configuration
      # existingConfig: "configmap-oauth2-proxy"
      ## Secret with the client ID, secret and cookie secret
      # existingSecret: "secret-oauth2proxy"
      configFile: |-
        email_domains = [ "*" ]
        upstreams = [ "static://202" ]

    # https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview
    extraArgs:
      provider: oidc
      provider-display-name: "Authentik"
      login-url: "https://auth.${SECRET_DOMAIN}.com/application/o/authorize/"
      oidc-issuer-url: "https://auth.${SECRET_DOMAIN}.com/application/o/k8s/"
      oidc-jwks-url: "https://auth.${SECRET_DOMAIN}.com/application/o/k8s/jwks/"
      redirect-url: "http://oauth2.${SECRET_DOMAIN}/oauth2/callback"
      upstream: static://202
      # insecure-oidc-skip-issuer-verification: false
      # oidc-email-claim: "email"
      # oidc-groups-claim: "groups"
      skip-provider-button: true
      reverse-proxy: true
      pass-basic-auth: true
      pass-authorization-header: true
      # pass-access-token: true
      # set-basic-auth: true
      # set-authorization-header: true
      # set-xauthrequest: true
      email-domain: "*"
      cookie-domain: ".${SECRET_DOMAIN}"
      whitelist-domain: ".${SECRET_DOMAIN}"
      silence-ping-logging: true
