---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: security
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: oauth2-proxy
      version: 1.0.2
      sourceRef:
        kind: HelmRepository
        name: bitnami-charts
        namespace: flux-system
  values:
    service:
      type: ClusterIP
      port: 80

    ingress:
      enabled: false
      hostname: oauth2-proxy.${SECRET_DOMAIN}
      path: /

    configuration:
      # clientID: "XXXXXXX"
      # clientSecret: "XXXXXXXX"
      # # Create a new secret with `openssl rand -base64 32 | head -c 32 | base64`
      # cookieSecret: "XXXXXXXXXXXXXXXX"
      ## Secret with the client ID, secret and cookie secret
      existingSecret: "secret-oauth2proxy"

      google:
        enabled: false

    extraArgs:
      provider: oidc
      login-url: "https://auth.${SECRET_DOMAIN}.com/application/o/authorize/"
      oidc-issuer-url: "https://auth.${SECRET_DOMAIN}.com/application/o/k8s/"
      oidc-jwks-url: "https://auth.${SECRET_DOMAIN}.com/application/o/k8s/jwks/"
      redirect-url: "http://oauth2.${SECRET_DOMAIN}/oauth2/callback"
      upstream: static://202
      # insecure-oidc-skip-issuer-verification: false
      # oidc-email-claim: "email"
      # oidc-groups-claim: "groups"
      skip-provider-button: true
      reverse-proxy: true
      pass-basic-auth: true
      pass-authorization-header: true
      pass-access-token: true
      set-basic-auth: true
      set-authorization-header: true
      set-xauthrequest: true
      email-domain: "*"
      cookie-domain: ".${SECRET_DOMAIN}"
      whitelist-domain: ".${SECRET_DOMAIN}"
