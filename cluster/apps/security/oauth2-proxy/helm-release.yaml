---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: security
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://oauth2-proxy.github.io/manifests
      chart: oauth2-proxy
      version: 5.0.6
      sourceRef:
        kind: HelmRepository
        name: oauth2-proxy-charts
        namespace: flux-system
  values:
    service:
      type: ClusterIP
      portNumber: 80

    ingress:
      enabled: false
      hostname: oauth2.${SECRET_DOMAIN}
      path: /

    proxyVarsAsSecrets: true
    config:
      # clientID: ${SECRET_O2P_DASHBOARD_ID}
      # clientSecret: ${SECRET_O2P_DASHBOARD_SECRET}
      # cookieSecret: ${SECRET_O2P_DASHBOARD_COOKIE}
      ## Secret with the client ID, secret and cookie secret
      existingSecret: "secret-oauth2proxy"
      # ## ConfigMap with the configuration
      # existingConfig: "configmap-oauth2-proxy"
      # configFile: |-
      #   email_domains = [ "*" ]
      #   upstreams = [ "file:///dev/null" ]

    # https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview
    extraArgs:
      provider: keycloak-oidc
      provider-display-name: Keycloak
      # client-id: ${SECRET_KEYCLOAK_CLIENT_ID}
      # client-secret: ${SECRET_O2P_DASHBOARD_SECRET}
      # cookie-secret: ${SECRET_O2P_DASHBOARD_COOKIE}
      oidc-issuer-url: "https://keycloak.${SECRET_DOMAIN}/auth/realms/${SECRET_KEYCLOAK_REALM}/"
      # redirect-url: "https://dashboard.${SECRET_DOMAIN}/oauth2/callback"
      redirect-url: https://oauth2.${SECRET_DOMAIN}/oauth2/callback
      # allowed-role: <realm role name> // Optional, required realm role
      # allowed-role: <client id>:<client role name> // Optional, required client role
      skip-provider-button: true
      reverse-proxy: true
      pass-authorization-header: true
      pass-access-token: true
      # pass-basic-auth: true
      # pass-host-headers: true
      # pass-user-headers: true
      # set-authorization-header: true
      # set-xauthrequest: true
      email-domain: "*"
      cookie-domain: .${SECRET_DOMAIN}
      whitelist-domain: .${SECRET_DOMAIN}
      silence-ping-logging: true

    # extraArgs:
    #   provider: oidc
    #   provider-display-name: "Authentik"
    #   login-url: "https://auth.${SECRET_DOMAIN}/application/o/authorize/"
    #   oidc-issuer-url: "https://auth.${SECRET_DOMAIN}/application/o/k8s/"
    #   oidc-jwks-url: "https://auth.${SECRET_DOMAIN}/application/o/k8s/jwks/"
    #   redirect-url: "https://oauth2.${SECRET_DOMAIN}/oauth2/callback"
    #   # insecure-oidc-skip-issuer-verification: true
    #   # oidc-email-claim: "email"
    #   # oidc-groups-claim: "groups"
    #   allowed-group: admin
    #   reverse-proxy: true
    #   pass-basic-auth: true
    #   # pass-authorization-header: true
    #   # pass-access-token: true
    #   # set-basic-auth: true
    #   set-authorization-header: true
    #   # set-xauthrequest: true
    #   # upstream: static://202
    #   cookie-domain: ".${SECRET_DOMAIN}"
    #   cookie-secure: true
    #   cookie-name: "_oauth2_proxy"
    #   email-domain: "*"
    #   whitelist-domain: ".${SECRET_DOMAIN}"
    #   silence-ping-logging: true
    #   skip-provider-button: true
