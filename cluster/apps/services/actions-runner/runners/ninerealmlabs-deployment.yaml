---
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &name ninerealmlabs
  namespace: &namespace actions-runner-system
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.1
      sourceRef:
        kind: HelmRepository
        name: dysnix-charts
        namespace: flux-system
  install:
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  dependsOn:
    - name: actions-runner-controller
      namespace: actions-runner-system
  values:
    resources:
      ### ------------------------------------------------------------------------------------------------------------
      - apiVersion: actions.summerwind.dev/v1alpha1
        kind: RunnerDeployment
        metadata:
          name: *name
          namespace: *namespace
        spec:
          # https://github.com/actions/actions-runner-controller/blob/master/docs/detailed-docs.md#runnerdeployments
          template:
            spec:
              ### deployment/pod spec
              image: ghcr.io/actions-runner-controller/actions-runner-controller/actions-runner-dind:ubuntu-22.04@sha256:0c662c9ffc6770cb021e5dff91789fa481966a6d42eefb6756ff48978a9109cb
              imagePullPolicy: Always
              dockerdWithinRunnerContainer: true
              ephemeral: true # true --> clear data between builds
              env:
                - name: STARTUP_DELAY_IN_SECONDS
                  value: "5"
              #   - name: POD_NAME
              #     valueFrom:
              #       fieldRef:
              #         fieldPath: metadata.name
              # dockerEnv:
              # - name: POD_NAME
              #   valueFrom:
              #     fieldRef:
              #       fieldPath: metadata.name
              resources:
                requests:
                  cpu: 2
                  memory: 4G
                limits:
                  # cpu: 4
                  memory: 8G
              securityContext:
                supplementalGroups:
                  - 65542
              # # cache: https://github.com/actions/actions-runner-controller/blob/master/docs/detailed-docs.md#pv-backed-runner-work-directory
              # # docker: https://github.com/actions/actions-runner-controller/blob/master/docs/detailed-docs.md#docker-image-layers-caching
              # volumes:
              #   # - name: cache-volume
              #   #   persistentVolumeClaim:
              #   #     claimName: actions-runner-controller-cache
              #   - name: docker-volume
              #     persistentVolumeClaim:
              #       claimName: actions-runner-controller-docker
              #   # - name: work-volume
              #   #   persistentVolumeClaim:
              #   #     claimName: actions-runner-controller-work
              # dockerVolumeMounts:
              #   - name: docker-volume
              #     mountPath: /var/lib/docker
              #     subPathExpr: $(POD_NAME)-docker
              ### spec for GHA integration
              group: ninerealmlabs-hosted
              labels:
                - self-hosted
              organization: ninerealmlabs
              # repository: ninerealmlabs/docker-jupyter-stacks
      ### ------------------------------------------------------------------------------------------------------------
      - apiVersion: actions.summerwind.dev/v1alpha1
        kind: HorizontalRunnerAutoscaler
        metadata:
          name: *name
          namespace: *namespace
        spec:
          # https://github.com/actions/actions-runner-controller/blob/master/docs/detailed-docs.md#runnerdeployments
          scaleTargetRef:
            name: *name
          scaleUpTriggers:
            - githubEvent:
                workflow_job: {}
                # checkRun:
                #   types: ["created"]
                #   status: "queued"
              amount: 1
              duration: "5m"
          minReplicas: 1
          maxReplicas: 3
          metrics:
            - type: TotalNumberOfQueuedAndInProgressWorkflowRuns
              repositoryNames:
                - ninerealmlabs/docker-jupyter-stacks
