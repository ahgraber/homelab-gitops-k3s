---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: linkace
  namespace: services
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.1.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  # install:
  #   createNamespace: true
  #   remediation:
  #     retries: 5
  # upgrade:
  #   remediation:
  #     retries: 5
  values:
    initContainers:
      init-shared-vol:
        image: linkace/linkace:v1.10.5
        command:
          - /bin/sh
          - -c
          - |-
            cp -r /app/public/. /share
        volumeMounts:
          - name: share
            mountPath: /share

    ### main image
    image:
      repository: nginx
      tag: stable
    annotations:
      reloader.stakater.com/search: "true"
      # configmap.reloader.stakater.com/reload: linkace-nginx-config
    env:
      NGINX_HOST: "linkace.${SECRET_DOMAIN}"

    service:
      main:
        ports:
          http:
            port: 8080
            targetPort: 80

    ingress:
      main:
        enabled: false

    persistence:
      nginx:
        enabled: true
        type: configMap
        name: linkace-nginx-config
        subPath: nginx.conf
        mountPath: /etc/nginx/nginx.conf
        readOnly: true
      share:
        enabled: true
        type: emptyDir
        mountPath: /app/public

    additionalContainers:
      # recursively uses main container's template
      - name: linkace-php
        image: linkace/linkace
        tag: v1.10.5

        annotations:
          reloader.stakater.com/search: "true"
          # configmap.reloader.stakater.com/reload: linkace-config
          # secret.reloader.stakater.com/reload: linkace-secret

        persistence:
          config:
            enabled: true
            type: secret
            name: linkace-secret
            subPath: env
            mountPath: /app/.env
            readOnly: false

        resources:
          requests:
            cpu: 100m
            memory: 100Mi
          limits:
            memory: 500Mi
