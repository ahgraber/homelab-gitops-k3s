---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kured
  namespace: kube-system
spec:
  interval: 15m
  chart:
    spec:
      chart: kured
      version: 4.1.0
      sourceRef:
        kind: HelmRepository
        name: kubereboot-charts
        namespace: flux-system
      interval: 15m
  values:
    configuration:
      logFormat: "json"
      timeZone: "${TIMEZONE}"
      startTime: "2am"
      endTime: "5am"

      # rebootSentinelCommand: |-
      #   sh -c "! needs-restarting --reboothint"

      ### block reboot for firing alerts?
      prometheus-url: http://prometheus-operated.monitoring.svc.cluster.local:9090
      alert-filter-regexp: |
        ^(RebootRequired|Watchdog)$

      ### drain & reboot process
      # drain-grace-period: -1
      # drain-timeout: 0  # timeout until drain abort (default: 0, infinite time)
      forceReboot: false
      rebootDelay: 30s # post-drain, pre-reboot delay
      # rebootCommand: "/bin/systemctl reboot"

      ### notify
      messageTemplateDrain: "⏳ Draining node %s"
      messageTemplateReboot: "♻️ Rebooted node %s"
      notify-url: "smtp://${SECRET_SMTP_USER}:${SECRET_SMTP_PWD}@in-v3.mailjet.com:587/?fromAddress=${SECRET_SMTP_ADDRESS}&toAddresses=${SECRET_DEFAULT_EMAIL}"

    metrics:
      create: true
      labels:
        release: kube-prometheus-stack

    tolerations:
      - key: "node-role.kubernetes.io/control-plane"
        operator: "Exists"
      - key: "node-role.kubernetes.io/etcd"
        operator: "Exists"
      - key: "node-role.kubernetes.io/master"
        operator: "Exists"
