---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: metrics-server
  namespace: kube-system
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://kubernetes-sigs.github.io/metrics-server/
      chart: metrics-server
      version: 0.5.1
      sourceRef:
        kind: HelmRepository
        name: metrics-server-charts
        namespace: flux-system
      interval: 5m
  values:
    image:
      repository: k8s.gcr.io/metrics-server/metrics-server
      # Overrides the image tag whose default is v{{ .Chart.AppVersion }}
      tag: ""
      pullPolicy: IfNotPresent

    serviceAccount:
      # Specifies whether a service account should be created
      create: true
      # Annotations to add to the service account
      annotations: {}
      # The name of the service account to use.
      # If not set and create is true, a name is generated using the fullname template
      name: ""

    rbac:
      # Specifies whether RBAC resources should be created
      create: true
      pspEnabled: false

    apiService:
      # Specifies if the v1beta1.metrics.k8s.io API service should be created.
      #
      # You typically want this enabled! If you disable API service creation you have to
      # manage it outside of this chart for e.g horizontal pod autoscaling to
      # work with this release.
      create: true

      securityContext:
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 1000
        allowPrivilegeEscalation: false

      priorityClassName: system-cluster-critical

      containerPort: 4443

      hostNetwork:
        enabled: false

      replicas: 1

      args:
        - --metric-resolution=15s
        - --cert-dir=/tmp
        - --secure-port=443
        - --kubelet-use-node-status-port
        - --kubelet-insecure-tls
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
