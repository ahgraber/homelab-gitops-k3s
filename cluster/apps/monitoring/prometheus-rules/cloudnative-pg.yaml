---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cnpg-rules
  namespace: monitoring
spec:
  groups:
    - name: cnp-default.rules
      rules:
        - alert: InstanceDown
          annotations:
            summary: Instance down {{$labels.instance}}
          expr: cnpg_collector_up == 0
          for: 10m
          labels:
            severity: error
        - alert: LongRunningTransaction
          annotations:
            description: Pod {{ $labels.pod }} is taking more than 5 minutes (300 seconds) for a query.
            summary: A query is taking longer than 5 minutes.
          expr: |-
            cnpg_backends_max_tx_duration_seconds > 300
          for: 1m
          labels:
            severity: warning
        - alert: HighResponseTime
          annotations:
            description: High response time in database {{$labels.datname}}
            summary: Transactions are taking more than 2 minutes
          expr: |-
            avg(rate(cnpg_backends_max_tx_duration_seconds{datname!~"template.*"}[5m])) by (datname) > 2 * 60
          for: 1m
          labels:
            severity: warning
        - alert: BackendsWaiting
          annotations:
            description: Pod {{ $labels.pod  }} has been waiting for longer than 5 minutes
            summary: If a backend is waiting for longer than 5 minutes
          expr: |-
            cnpg_backends_waiting_total > 300
          for: 1m
          labels:
            severity: warning
        - alert: PGDatabase
          annotations:
            description: Over 150,000,000 transactions from frozen xid on pod {{ $labels.pod  }}
            summary: Number of transactions from the frozen XID to the current one
          expr: |-
            cnpg_pg_database_xid_age > 150000000
          for: 1m
          labels:
            severity: warning
        - alert: PGReplication
          annotations:
            description: Standby is lagging behind by over 300 seconds (5 minutes)
            summary: The standby is lagging behind the primary
          expr: |-
            cnpg_pg_replication_lag > 300
          for: 1m
          labels:
            severity: warning
        # - alert: LastFailedArchiveTime
        #   annotations:
        #     description: Archiving failed for {{ $labels.pod }}
        #     summary: Checks the last time archiving failed. Will be -1 when it has not failed.
        #   expr: |-
        #     cnpg_pg_stat_archiver_last_failed_time > 1
        #   for: 1m
        #   labels:
        #     severity: warning
        - alert: HighWALFilesArchiveErrorRate
          annotations:
            summary: High error rate in WAL files archiver in instance {{$labels.instance}}
          expr: |-
            rate(cnpg_pg_stat_archiver_failed_count[5m]) /
            (rate(cnpg_pg_stat_archiver_archived_count[5m]) +
              rate(cnpg_pg_stat_archiver_failed_count[5m])) > 0.1
          for: 10m
          labels:
            severity: warning
        - alert: DeadlocksInDatabase
          annotations:
            summary: Deadlocks in database {{$labels.datname}}
          expr: |-
            rate(cnpg_pg_stat_database_deadlocks{datname!~"template.*"}[5m]) > 0
          for: 10m
          labels:
            severity: warning
