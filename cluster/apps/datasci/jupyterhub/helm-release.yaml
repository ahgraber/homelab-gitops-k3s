---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: jupyterhub
  namespace: datasci
spec:
  interval: 5m
  timeout: 20m
  chart:
    spec:
      # renovate: registryUrl=https://jupyterhub.github.io/helm-chart/
      chart: jupyterhub
      version: 2.0.0
      sourceRef:
        kind: HelmRepository
        name: jupyterhub-charts
        namespace: flux-system
      interval: 5m

  install:
    remediation:
      retries: 4
  upgrade:
    remediation:
      remediateLastFailure: true

  values:
    hub:
      annotations:
        reloader.stakater.com/search: "true"
      authenticatePrometheus: false
      # # pass as valuesFrom secret
      # db:
      #   type: postgres
      #   url: postgresql+psycopg2://<db-username>:<db-password>@<db-hostname>:<db-port>/<db-name>
      # config:
      #   Authenticator:
      #     admin_users:
      #       - ${JHUB_ADMIN}
      #     allowed_users:
      #       - ${JHUB_USER}
      #   JupyterHub:
      #     authenticator_class: dummy
      #   DummyAuthenticator:
      #     password: ""

    ingress:
      enabled: false
    # prePuller:
    #   hook:
    #     nodeSelector:
    #       kubernetes.io/arch: amd64
    singleuser:
      defaultUrl: "/lab"
      extraEnv:
        JUPYTERHUB_SINGLEUSER_APP: "jupyter_server.serverapp.ServerApp"
      cpu:
        limit: 4
        guarantee: 0.05
      memory:
        limit: 8G
        guarantee: 512M
      storage:
        capacity: 15Gi
        dynamic:
          storageClass: ceph-block
          pvcNameTemplate: claim-{username}{servername}
          volumeNameTemplate: volume-{username}{servername}
          storageAccessModes: [ReadWriteOnce]
      # Defines the default image
      image:
        name: jupyter/scipy-notebook
        tag: 82ce73789ba4
      profileList:
        - display_name: "Datascience environment"
          description: "If you want the additional bells and whistles: Python, R, and Julia."
          default: true
        - display_name: "Minimal environment"
          description: "To avoid too much bells and whistles: Python."
          kubespawner_override:
            image: jupyter/minimal-notebook:82ce73789ba4
        - display_name: "Spark environment"
          description: "The Jupyter Stacks spark image!"
          kubespawner_override:
            image: jupyter/all-spark-notebook:2343e33dec46
        # - display_name: "Learning Data Science"
        #   description: "Datascience Environment with Sample Notebooks"
        #   kubespawner_override:
        #     image: jupyter/datascience-notebook:2343e33dec46
        #     # lifecycle_hooks:
        #     #   postStart:
        #     #     exec:
        #     #       command:
        #     #         - "sh"
        #     #         - "-c"
        #     #         - >
        #     #           gitpuller https://github.com/data-8/materials-fa17 master materials-fa;
      # # copy config files from /tmp/ to user home
      lifecycleHooks:
        postStart:
          exec:
            command:
              - "sh"
              - "-c"
              - >
                cp /tmp/* /home/jovyan/

      # # notebook settings configuration
      # extraFiles:
      #   # jupyter_notebook_config reference: https://jupyter-notebook.readthedocs.io/en/stable/config.html
      #   jupyter_notebook_config.json:
      #     mountPath: /etc/jupyter/jupyter_notebook_config.json
      #     # data is a YAML structure here but will be rendered to JSON file as our
      #     # file extension is ".json".
      #     data:
      #       MappingKernelManager:
      #         # cull_idle_timeout: timeout (in seconds) after which an idle kernel is
      #         # considered ready to be culled
      #         cull_idle_timeout: 1200 # default: 0

      #         # cull_interval: the interval (in seconds) on which to check for idle
      #         # kernels exceeding the cull timeout value
      #         cull_interval: 120 # default: 300

      #         # cull_connected: whether to consider culling kernels which have one
      #         # or more connections
      #         cull_connected: true # default: false

      #         # cull_busy: whether to consider culling kernels which are currently
      #         # busy running some code
      #         cull_busy: false # default: false
      # # determine where to run singleuser pods
      # extraNodeAffinity:
      #   required:
      #     - matchExpressions:
      #       - key: kubernetes.io/arch
      #         operator: In
      #         values:
      #           - amd64
      #           - i386
      #           - i686
      #           - x86

  valuesFrom:
    # created by rook-ceph in ObjectBucketClaim thanos-ceph-bucket
    - targetPath: hub.db
      kind: Secret
      name: jupyterhub-secret
      valuesKey: db
    - targetPath: hub.config
      kind: Secret
      name: jupyterhub-secret
      valuesKey: config
